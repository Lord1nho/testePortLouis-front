<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Agenda Telef√¥nica</title>
    <!-- Vuetify CSS -->
    <!-- Vuetify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/vuetify@3.5.16/dist/vuetify.min.css" rel="stylesheet">

    <!-- Material Design Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
</head>
<body>
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-demi"></script>
<script src="https://cdn.jsdelivr.net/npm/@vuelidate/core"></script>
<script src="https://cdn.jsdelivr.net/npm/@vuelidate/validators"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@3.5.16/dist/vuetify.min.js"></script>

<div id="app">
    <v-app>
        <v-container
                class="d-flex align-center justify-center "
                style="height: 100vh;"
        >
            <v-sheet  class="pa-2 rounded-lg bg-grey-lighten-3" width="800">
                <v-toolbar class="bg-grey-lighten-3 mb-4 mt-2">
                    <v-toolbar-title>
                        <div >
                            <h2>Lista de Contatos</h2>
                            <p style="opacity: 0.7;">Adicionar, editar ou excluir contatos</p>
                        </div>
                    </v-toolbar-title>
                    <v-btn class="elevation-0" variant="plain" icon @click="criarContato">
                        <v-icon>mdi-account-plus-outline</v-icon>
                    </v-btn>
                </v-toolbar>

                <v-divider class="border-opacity-100"></v-divider>

                <! -- Lista de contatos -->
                <v-data-table class="bg-grey-lighten-3"
                        :headers="headers"
                        :items="items"
                        no-data-text="Sem Contatos a Exibir"
                        items-per-page-text="Contatos por p√°gina"
                        items-per-page="5"
                        :items-per-page-options="[5, 10, 15, -1]"
                >
                    <!-- Slot para a coluna 'actions' -->
                    <template v-slot:item="{ item }">
                        <tr :class="item.numero_contato?.startsWith('(11)') ? 'background11' : ''">
                            <td>{{ item.nome }}</td>
                            <td>{{ item.numero_contato }}</td>
                            <td class="d-flex align-center justify-end">
                                <v-btn variant="plain"  style="margin: 8px"  icon class="elevation-0" @click="editar(item)">
                                    <v-icon>mdi-account-edit-outline</v-icon>
                                </v-btn>
                                <v-btn variant="plain" icon class="elevation-0" @click="excluir(item)">
                                    <v-icon color="error">mdi-delete-outline</v-icon>
                                </v-btn>
                            </td>
                        </tr>
                    </template>
                </v-data-table>


            </v-sheet>
        </v-container>
    </v-app>
    <v-dialog v-model="dialog" max-width="500" >
        <v-card class="px-4 py-2" v-click-outside="reset">
            <v-card-title class="pa-0 mb-4 mt-2">{{ titleModal }}</v-card-title>
            <v-form v-model="formOk" ref="form" @submit.prevent="submitForm">
                <v-text-field
                        variant="outlined"
                        :rules="[validaNome]"
                        label="Nome" placeholder="Ex: Jo√£o Silva"
                        required
                        v-model="contato.nome"></v-text-field>
                <v-text-field
                        variant="outlined"
                        :rules="[v => !!v || 'N√∫mero √© obrigat√≥rio',
                                             v => v.length === 14  || 'Formato (XX) XXXX-XXXX']"
                        label="N√∫mero" required
                        @input="regexTelephone"
                        v-model="contato.numero_contato"></v-text-field>
                </v-text-field>
                <v-card-actions >
                    <v-spacer></v-spacer>
                    <v-btn class="px-5" :disabled="!formOk" text type="submit">{{button}}</v-btn>
                    <v-btn class="px-5" text @click="reset()">Cancelar</v-btn>
                </v-card-actions>
            </v-form>
        </v-card>
    </v-dialog>
</div>

<script>
    const { createApp, ref, onMounted, reactive } = Vue
    const { createVuetify } = Vuetify

    const vuetify = createVuetify()

    createApp({
        setup() {

            /* CONSTRU√á√ÉO DA LISTA */
            const headers = ref([
                { title: 'Nome', key: 'nome' },
                { title: 'Telefone', key: 'numero_contato', sortable: false },
                { key: 'actions', sortable: false } // coluna extra
            ])

            const items = ref([])
            const page = ref(1)
            async function carregarContatos() {
                const res = await fetch("http://localhost:3000/contatos")
                items.value = await res.json()
                console.log(items.value);
            }


            /*  vari√°veis utilizadas */
            const dialog = ref(false)
            const form = ref(false)
            const titleModal = ref('');
            const button = ref('')
            const contato = reactive({
                id: null,
                nome: '',
                numero_contato: ''
            })


            /* reset, valida√ß√µes e regex */
            function reset() {
                dialog.value = false;
                contato.nome = ''
                contato.numero_contato = ''
            }

            function validaNome(v) {
                if (!v) return 'Nome √© obrigat√≥rio'
                const partes = v.trim().split(' ')
                if (partes.length < 2) return 'Nome deve conter ao menos 2 palavras'
                if (partes.some(p => p.length < 3)) return 'Cada palavra deve ter no m√≠nimo 3 letras'
                return true
            }

            function regexTelephone() {
                // Remove tudo que n√£o √© d√≠gito
                let telefone = contato.numero_contato
                telefone = telefone.replace(/\D/g, '');

                telefone = telefone.replace(/^(\d{2})(\d)/, '($1) $2');
                telefone = telefone.replace(/(\d)(\d{4})$/, '$1-$2');
                contato.numero_contato = telefone;
            }

            /* CREATE */

          function criarContato() {
                titleModal.value = 'Adicionar Contato'
                button.value = 'Adicionar'
                dialog.value = true;
            }

            async function adicionaContato(){
                try {
                    const response = await fetch("http://localhost:3000/adicionar", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(contato)
                    });
                    console.log("C√≥digo HTTP:", response.status); // ex: 201, 400, 500

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Contato salvo:", data);
                        await carregarContatos();
                        reset();
                        dialog.value = false;
                    } else {
                        const errorText = await response.json(); // ou response.json() se o backend retornar JSON
                        console.error("Erro ao salvar:", response.status, errorText);
                    }
                } catch (error) {
                    console.error('Erro ao realizar requisi√ß√£o:', error)
                }
            }


            /* UPDATE */

            function editar(item) {
                titleModal.value = 'Editar Contato'
                contato.id = item.id        // pega o id
                contato.nome = item.nome
                contato.numero_contato = item.numero_contato
                button.value = 'Salvar'
                dialog.value = true;
            }

            async function editaContato(id) {
                try {
                    const response = await fetch(`http://localhost:3000/editarUser/${id}`, {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            nome: contato.nome,
                            numero_contato: contato.numero_contato
                        })
                    });

                    console.log("C√≥digo HTTP:", response.status);

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Contato atualizado:", data);
                        await carregarContatos();
                        reset();
                        dialog.value = false;
                    } else {
                        const errorText = await response.json();
                        console.error("Erro ao editar:", response.status, errorText);
                        alert(`Erro ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error("Erro ao realizar requisi√ß√£o:", error);
                }
            }

            /* DELETE */

            async function excluir(item) {
                try {
                    const response = await fetch(`http://localhost:3000/deleteUser/${item.id}`, {
                        method: "DELETE",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(contato)
                    });
                    console.log("C√≥digo HTTP:", response.status);

                    if (response.ok) {
                       await carregarContatos();
                    } else {
                        const errorText = await response.json();
                        console.error("Erro ao salvar:", response.status, errorText);
                        alert(`Erro ${response.status}: ${errorText}`);
                    }
                } catch (error) {
                    console.error('Erro ao realizar requisi√ß√£o:', error)
                }
            }

            /* SUBMIT FORM */

            let formOk = ref(false)
            async function submitForm() {

                const { valid } = await form.value.validate()
                if (!valid) return
                console.log(form.value.valid)
                formOk.value = true;
                if (button.value === 'Adicionar') {
                    adicionaContato();
                } else {
                    editaContato(contato.id);
                }
            }


            // üîπ Chama automaticamente quando o componente √© montado
            onMounted(() => {
                carregarContatos()
            })

            return {
                headers,
                items,
                editar,
                excluir,
                dialog,
                titleModal,
                button,
                contato,
                criarContato,
                submitForm,
                form,
                reset,
                regexTelephone,
                validaNome,
                formOk
            }
        }
    })
        .use(vuetify)
        .mount('#app')
</script>
</body>

<style>
    .v-application {
        background-image: linear-gradient(to right, #243949 0%, #517fa4 100%);
        font-family: 'Montserrat', sans-serif;
    }

   .background11 {
       background-color: #517FA4FF
   }

</style>
</html>
